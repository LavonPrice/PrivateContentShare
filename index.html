<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Content Sharing Platform</title>
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #ff5e62 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #718096;
            font-size: 1.1em;
        }

        .wallet-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #ff6b35;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #ff6b35 0%, #ff5e62 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f7931e 0%, #fdc830 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .content-card h3 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .content-card p {
            color: #718096;
            margin-bottom: 15px;
        }

        .content-meta {
            font-size: 0.9em;
            color: #a0aec0;
            margin-bottom: 15px;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.success {
            background-color: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status.error {
            background-color: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }

        .status.warning {
            background-color: #fefcbf;
            color: #744210;
            border: 1px solid #faf089;
        }

        .wallet-info {
            background: linear-gradient(135deg, #ff6b35 0%, #ff5e62 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .tab-container {
            display: flex;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            background: #e2e8f0;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-right: 5px;
            border-radius: 8px 8px 0 0;
            transition: background-color 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, #ff6b35 0%, #ff5e62 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Private Content Sharing Platform</h1>
            <p>Secure content sharing with fully homomorphic encryption powered by Zama</p>
        </div>

        <div class="wallet-section">
            <button id="connectWallet" class="btn">Connect Wallet</button>
            <div id="walletInfo" class="wallet-info hidden">
                <strong>Connected:</strong> <span id="walletAddress"></span>
            </div>
        </div>

        <div id="statusMessage" class="status hidden"></div>

        <div class="tab-container">
            <button class="tab active" onclick="showTab('create')">Create Content</button>
            <button class="tab" onclick="showTab('browse')">Browse Content</button>
            <button class="tab" onclick="showTab('myContent')">My Content</button>
            <button class="tab" onclick="showTab('myAccess')">My Access</button>
        </div>

        <div id="createTab" class="tab-content active">
            <div class="section">
                <h2>Create Encrypted Content</h2>
                <div class="form-group">
                    <label for="contentTitle">Title:</label>
                    <input type="text" id="contentTitle" placeholder="Enter content title">
                </div>
                <div class="form-group">
                    <label for="contentDescription">Description:</label>
                    <textarea id="contentDescription" rows="3" placeholder="Enter content description"></textarea>
                </div>
                <div class="form-group">
                    <label for="contentData">Content Data (numeric):</label>
                    <input type="number" id="contentData" placeholder="Enter numeric content data">
                </div>
                <div class="form-group">
                    <label for="accessPrice">Access Price (wei):</label>
                    <input type="number" id="accessPrice" placeholder="Enter access price in wei">
                </div>
                <button id="createContentBtn" class="btn">Create Content</button>
            </div>
        </div>

        <div id="browseTab" class="tab-content">
            <div class="section">
                <h2>Browse Available Content</h2>
                <button id="loadContentBtn" class="btn btn-secondary">Load Content</button>
                <div id="contentList" class="content-grid"></div>
            </div>
        </div>

        <div id="myContentTab" class="tab-content">
            <div class="section">
                <h2>My Created Content</h2>
                <button id="loadMyContentBtn" class="btn btn-secondary">Load My Content</button>
                <div id="myContentList" class="content-grid"></div>
            </div>
        </div>

        <div id="myAccessTab" class="tab-content">
            <div class="section">
                <h2>My Access Tokens</h2>
                <button id="loadMyAccessBtn" class="btn btn-secondary">Load My Access</button>
                <div id="myAccessList" class="content-grid"></div>
            </div>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = '0xc074E746C511a192847e47A0ac884DA6e7D16976';
        const CONTRACT_ABI = [
            "function createContent(uint64 _encryptedData, uint32 _accessPrice, string memory _title, string memory _description) external returns (uint256)",
            "function purchaseAccess(uint256 _contentId, uint256 _duration) external payable returns (uint256)",
            "function accessContent(uint256 _contentId) external returns (bytes32)",
            "function revokeAccess(uint256 _contentId, address _user) external",
            "function updateContentStatus(uint256 _contentId, bool _isActive) external",
            "function getContentInfo(uint256 _contentId) external view returns (address creator, string memory title, string memory description, uint256 timestamp, bool isActive)",
            "function getUserContents(address _user) external view returns (uint256[] memory)",
            "function getUserAccessTokens(address _user) external view returns (uint256[] memory)",
            "function getAccessTokenInfo(uint256 _tokenId) external view returns (uint256 contentId, address tokenOwner, uint256 expirationTime, bool isValid)",
            "function checkAccess(uint256 _contentId, address _user) external view returns (bool)",
            "function getTotalContents() external view returns (uint256)",
            "function getTotalAccessTokens() external view returns (uint256)",
            "event ContentCreated(uint256 indexed contentId, address indexed creator, string title, uint256 timestamp)",
            "event AccessPurchased(uint256 indexed contentId, address indexed buyer, uint256 indexed tokenId, uint256 expirationTime)",
            "event ContentAccessed(uint256 indexed contentId, address indexed accessor, uint256 timestamp)",
            "event AccessRevoked(uint256 indexed contentId, address indexed user, uint256 timestamp)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;

        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                    document.getElementById('walletAddress').textContent = userAddress;
                    document.getElementById('walletInfo').classList.remove('hidden');
                    document.getElementById('connectWallet').textContent = 'Connected';
                    document.getElementById('connectWallet').disabled = true;

                    showStatus('Wallet connected successfully!', 'success');
                } else {
                    showStatus('Please install MetaMask!', 'error');
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showStatus('Error connecting wallet: ' + error.message, 'error');
            }
        }

        async function createContent() {
            try {
                if (!contract) {
                    showStatus('Please connect your wallet first', 'error');
                    return;
                }

                const title = document.getElementById('contentTitle').value;
                const description = document.getElementById('contentDescription').value;
                const contentData = document.getElementById('contentData').value;
                const accessPrice = document.getElementById('accessPrice').value;

                if (!title || !description || !contentData || !accessPrice) {
                    showStatus('Please fill in all fields', 'error');
                    return;
                }

                showStatus('Creating content...', 'warning');

                const tx = await contract.createContent(
                    ethers.BigNumber.from(contentData),
                    ethers.BigNumber.from(accessPrice),
                    title,
                    description
                );

                await tx.wait();
                showStatus('Content created successfully!', 'success');

                // Clear form
                document.getElementById('contentTitle').value = '';
                document.getElementById('contentDescription').value = '';
                document.getElementById('contentData').value = '';
                document.getElementById('accessPrice').value = '';

            } catch (error) {
                console.error('Error creating content:', error);
                showStatus('Error creating content: ' + error.message, 'error');
            }
        }

        async function loadContent() {
            try {
                if (!contract) {
                    showStatus('Please connect your wallet first', 'error');
                    return;
                }

                showStatus('Loading content...', 'warning');

                const totalContents = await contract.getTotalContents();
                const contentList = document.getElementById('contentList');
                contentList.innerHTML = '';

                for (let i = 1; i <= totalContents.toNumber(); i++) {
                    try {
                        const contentInfo = await contract.getContentInfo(i);
                        const [creator, title, description, timestamp, isActive] = contentInfo;

                        if (isActive) {
                            const contentCard = createContentCard(i, creator, title, description, timestamp, 'browse');
                            contentList.appendChild(contentCard);
                        }
                    } catch (error) {
                        console.log(`Content ${i} not found or error:`, error.message);
                    }
                }

                showStatus('Content loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading content:', error);
                showStatus('Error loading content: ' + error.message, 'error');
            }
        }

        async function loadMyContent() {
            try {
                if (!contract || !userAddress) {
                    showStatus('Please connect your wallet first', 'error');
                    return;
                }

                showStatus('Loading your content...', 'warning');

                const myContentIds = await contract.getUserContents(userAddress);
                const myContentList = document.getElementById('myContentList');
                myContentList.innerHTML = '';

                for (let contentId of myContentIds) {
                    try {
                        const contentInfo = await contract.getContentInfo(contentId);
                        const [creator, title, description, timestamp, isActive] = contentInfo;

                        const contentCard = createContentCard(contentId.toNumber(), creator, title, description, timestamp, 'manage');
                        myContentList.appendChild(contentCard);
                    } catch (error) {
                        console.log(`Error loading content ${contentId}:`, error.message);
                    }
                }

                showStatus('Your content loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading your content:', error);
                showStatus('Error loading your content: ' + error.message, 'error');
            }
        }

        async function loadMyAccess() {
            try {
                if (!contract || !userAddress) {
                    showStatus('Please connect your wallet first', 'error');
                    return;
                }

                showStatus('Loading your access tokens...', 'warning');

                const myAccessTokens = await contract.getUserAccessTokens(userAddress);
                const myAccessList = document.getElementById('myAccessList');
                myAccessList.innerHTML = '';

                for (let tokenId of myAccessTokens) {
                    try {
                        const tokenInfo = await contract.getAccessTokenInfo(tokenId);
                        const [contentId, tokenOwner, expirationTime, isValid] = tokenInfo;

                        const contentInfo = await contract.getContentInfo(contentId);
                        const [creator, title, description, timestamp, isActive] = contentInfo;

                        const accessCard = createAccessCard(tokenId.toNumber(), contentId.toNumber(), title, expirationTime.toNumber(), isValid);
                        myAccessList.appendChild(accessCard);
                    } catch (error) {
                        console.log(`Error loading access token ${tokenId}:`, error.message);
                    }
                }

                showStatus('Your access tokens loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading your access tokens:', error);
                showStatus('Error loading your access tokens: ' + error.message, 'error');
            }
        }

        function createContentCard(contentId, creator, title, description, timestamp, type) {
            const card = document.createElement('div');
            card.className = 'content-card';

            const date = new Date(timestamp * 1000).toLocaleDateString();
            const isOwner = userAddress && creator.toLowerCase() === userAddress.toLowerCase();

            let buttons = '';
            if (type === 'browse' && !isOwner) {
                buttons = `
                    <button class="btn btn-secondary" onclick="purchaseAccess(${contentId})">Purchase Access</button>
                    <button class="btn" onclick="viewContent(${contentId})">View Content</button>
                `;
            } else if (type === 'manage') {
                buttons = `
                    <button class="btn" onclick="viewContent(${contentId})">View Content</button>
                    <button class="btn btn-danger" onclick="toggleContentStatus(${contentId})">Toggle Status</button>
                `;
            }

            card.innerHTML = `
                <h3>${title}</h3>
                <p>${description}</p>
                <div class="content-meta">
                    <div>Creator: ${creator.substring(0, 10)}...</div>
                    <div>Created: ${date}</div>
                    <div>Content ID: ${contentId}</div>
                </div>
                ${buttons}
            `;

            return card;
        }

        function createAccessCard(tokenId, contentId, title, expirationTime, isValid) {
            const card = document.createElement('div');
            card.className = 'content-card';

            const expDate = new Date(expirationTime * 1000).toLocaleDateString();
            const isExpired = Date.now() > expirationTime * 1000;

            card.innerHTML = `
                <h3>${title}</h3>
                <div class="content-meta">
                    <div>Content ID: ${contentId}</div>
                    <div>Token ID: ${tokenId}</div>
                    <div>Expires: ${expDate}</div>
                    <div>Status: ${isValid && !isExpired ? 'Valid' : 'Invalid/Expired'}</div>
                </div>
                <button class="btn" onclick="viewContent(${contentId})" ${isValid && !isExpired ? '' : 'disabled'}>
                    Access Content
                </button>
            `;

            return card;
        }

        async function purchaseAccess(contentId) {
            try {
                const duration = prompt('Enter access duration in seconds (e.g., 86400 for 24 hours):');
                if (!duration) return;

                showStatus('Purchasing access...', 'warning');

                const tx = await contract.purchaseAccess(contentId, parseInt(duration));
                await tx.wait();

                showStatus('Access purchased successfully!', 'success');
            } catch (error) {
                console.error('Error purchasing access:', error);
                showStatus('Error purchasing access: ' + error.message, 'error');
            }
        }

        async function viewContent(contentId) {
            try {
                showStatus('Accessing content...', 'warning');

                const hasAccess = await contract.checkAccess(contentId, userAddress);
                if (!hasAccess) {
                    showStatus('You do not have access to this content', 'error');
                    return;
                }

                const contentBytes = await contract.accessContent(contentId);
                showStatus(`Content accessed! Data: ${contentBytes}`, 'success');
            } catch (error) {
                console.error('Error accessing content:', error);
                showStatus('Error accessing content: ' + error.message, 'error');
            }
        }

        async function toggleContentStatus(contentId) {
            try {
                showStatus('Updating content status...', 'warning');

                // For simplicity, we'll toggle to inactive. In a real app, you'd check current status first.
                const tx = await contract.updateContentStatus(contentId, false);
                await tx.wait();

                showStatus('Content status updated!', 'success');
            } catch (error) {
                console.error('Error updating content status:', error);
                showStatus('Error updating content status: ' + error.message, 'error');
            }
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.classList.remove('hidden');

            setTimeout(() => {
                statusElement.classList.add('hidden');
            }, 5000);
        }

        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('createContentBtn').addEventListener('click', createContent);
        document.getElementById('loadContentBtn').addEventListener('click', loadContent);
        document.getElementById('loadMyContentBtn').addEventListener('click', loadMyContent);
        document.getElementById('loadMyAccessBtn').addEventListener('click', loadMyAccess);

        // Auto-connect if wallet was previously connected
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    connectWallet();
                }
            }
        });
    </script>
</body>
</html>